SELECT A.MERCHANT_ID, A.MERCHANT_TOKEN, D.MERCHANT_NAME, 
-- FECHAS MOVIMIENTOS -- 
B.TRANSACTION_DATE_LOCAL, D.REPORT_DATE_LOCAL, A.CREATED_AT, A.UPDATED_AT,
-- DATOS TRANSACCION BD --
A.TRANSACTION_ID, C.REPORT_ID, A.PSP, A.ISSUER, A.ORDER_ID,
-- DATOS TRANSACCION BANCOS --
CASE WHEN A.PSP='AMEX' THEN 'AMEX' ELSE A.AFFILIATION END AFFILIATION, 
A.LAST4, A.TERM NUM_PAGOS, E.CARD_TYPE, E.BIN, 0 CARD_TYPE_FIN,
-- STATUS TRANSACCIONES --
A.STATUS_CODE, A.STATUS_MSG, A.TRX_ID COD_AUTH,
-- MONTOS POR TRANSACCION --
A.AMOUNT,  B.FEES_CHARGED, B.TAXES, 
CASE WHEN C.AMOUNT_DUE IS NULL THEN A.AMOUNT-B.FEES_CHARGED-B.TAXES
ELSE C.AMOUNT_DUE END AMOUNT_DUE,
-- MSI --
CASE WHEN B.term IS NULL THEN 0 ELSE B.term END AS MSI
FROM "PRD_CLIP_ANALYTICS"."CLIPDW_TRANSACTION"."PAYMENT" A
LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_SETTLEMENT"."ITEM_TRANSACTIONS" B
    ON A.MERCHANT_ID=B.MERCHANT_ID
    AND A.TRANSACTION_ID=B.TRANSACTION_ID
LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_SETTLEMENT"."REPORT_TRANSACTION_LINE_ITEMS" C
    ON B.ITEM_ID=C.ITEM_ID
LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_SETTLEMENT"."REPORTS" D
    ON A.MERCHANT_ID=D.MERCHANT_ID
    AND C.REPORT_ID=D.REPORT_ID
LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_TRANSACTION"."TRANSACTION_BIN_PROFILE" E
    ON A.TRANSACTION_ID=E.TRANSACTION_ID
WHERE DATE(A.CREATED_AT) >= '2021-11-25'
AND DATE(A.CREATED_AT) <= '2022-01-05'
--AND (PSP = 'PROSA' OR PSP = 'MIT-3DS')
--AND A.TRANSACTION_ID IN ('b1d1efe6-8504-4198-a491-594890646f52')
ORDER BY A.CREATED_AT
--WHERE A.TRANSACTION_ID IN ('8219ee05-c956-4054-9abd-6247113ca9f8')