WITH SETTLED AS (
    SELECT
        TO_DATE(HEADER.FECHA_DEPOSITO, 'YYYYMMDD') AS FECHA_DEPOSITO
        , TO_DATE(DETAIL.FECHA_TRX_7, 'YYYYMMDD') AS FECHA_TRX
        , CASE
            WHEN ID_COMERCIO_2 IN ('08672604','08380402','08343798','09118479','08668161') THEN 'ECOMMERCE'
            ELSE 'BANORTE'
          END AS ADQUIRENTE
        , DETAIL.TIPO_TRX_10 AS TIPO_TRX
        , DETAIL.NUMERO_PAGOS_19 AS MSI
        , COUNT(*) AS NUMERO_TRANSACCIONES
        , SUM(DETAIL.IMPORTE_BRUTO_8/100) AS TOTAL_IMPORTE_BRUTO
        , SUM(DETAIL.MONTO_DEPOSITADO_5/100) AS TOTAL_MONTO_DEPOSITADO
        , SUM(COMISION_ADQUIRENTE_33/100) AS COMISION_MDR
        , SUM(IVA_ADQUIRENTE_34/100) AS IVA_MDR
        , SUM(COMISIONES_PAGOS_DIFERIDOS_17/100) AS COMISION_MSI
        , SUM(IMPUESTOS_PAGOS_DIFERIDOS_12/100) AS IVA_MSI
    FROM PRD_CLIP_ANALYTICS.CLIPDS_STAGE_INTEGRATIONS.BANORTE_RECONCILIATION_DETAIL AS DETAIL
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDS_STAGE_INTEGRATIONS.BANORTE_RECONCILIATION_HEADER AS HEADER
        ON DETAIL.FILE_ID = HEADER.FILE_ID
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDS_BANORTE_RECONCILIATION.BANORTE_INDEX AS INDEX
        ON INDEX.RECORD_HASH_ADQ_SETTLED = DETAIL.RECORD_HASH
    WHERE
        TRUE
        AND DETAIL.TIPO_TRX_10 = 'SETTLED'
        AND ZEROIFNULL(INDEX.TYPE_OF_TRANSACTION) <> 1
    GROUP BY FECHA_DEPOSITO, FECHA_TRX, ADQUIRENTE, TIPO_TRX, MSI
)
, REFUNDED AS (
    SELECT
        TO_DATE(HEADER.FECHA_DEPOSITO, 'YYYYMMDD') AS FECHA_DEPOSITO
        , TO_DATE(DETAIL.FECHA_TRX_7, 'YYYYMMDD') AS FECHA_TRX
        , CASE
            WHEN ID_COMERCIO_2 IN ('08672604','08380402','08343798','09118479','08668161') THEN 'ECOMMERCE'
            ELSE 'BANORTE'
          END AS ADQUIRENTE
        , DETAIL.TIPO_TRX_10 AS TIPO_TRX
        , DETAIL.NUMERO_PAGOS_19 AS MSI
        , COUNT(*) AS NUMERO_TRANSACCIONES
        , SUM(DETAIL.IMPORTE_BRUTO_8/100) AS TOTAL_IMPORTE_BRUTO
        , SUM(DETAIL.MONTO_DEPOSITADO_5/100) AS TOTAL_MONTO_DEPOSITADO
        , SUM(COMISION_ADQUIRENTE_33/100) AS COMISION_MDR
        , SUM(IVA_ADQUIRENTE_34/100) AS IVA_MDR
        , SUM(COMISIONES_PAGOS_DIFERIDOS_17/100) AS COMISION_MSI
        , SUM(IMPUESTOS_PAGOS_DIFERIDOS_12/100) AS IVA_MSI
    FROM PRD_CLIP_ANALYTICS.CLIPDS_STAGE_INTEGRATIONS.BANORTE_RECONCILIATION_DETAIL AS DETAIL
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDS_STAGE_INTEGRATIONS.BANORTE_RECONCILIATION_HEADER AS HEADER
        ON DETAIL.FILE_ID = HEADER.FILE_ID
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDS_BANORTE_RECONCILIATION.BANORTE_INDEX AS INDEX
        ON INDEX.RECORD_HASH_ADQ_REFUNDED= DETAIL.RECORD_HASH
    WHERE
        TRUE
        AND DETAIL.TIPO_TRX_10 = 'REFUNDED'
        AND ZEROIFNULL(INDEX.TYPE_OF_TRANSACTION) <> 1
    GROUP BY FECHA_DEPOSITO, FECHA_TRX, ADQUIRENTE, TIPO_TRX, MSI
)
, BASE AS(
    SELECT *
    FROM SETTLED
    UNION ALL
    SELECT *
    FROM REFUNDED
)
SELECT *
FROM BASE
WHERE
    TRUE
    AND BASE.FECHA_DEPOSITO = '2023-09-01'
ORDER BY FECHA_DEPOSITO DESC
    , FECHA_TRX DESC
    , ADQUIRENTE ASC
    , TIPO_TRX DESC
    , MSI ASC