SELECT 
DISBURSEMENT_BATCH_ID,
TOTAL_DISBURSEMENTS,
REPORT_DATE_LOCAL,
DATE_TRUNC('MONTH', REPORT_DATE_LOCAL) AS REPORT_DATE_LOCAL_MONTH,
SUM(AMOUNT) AS AMOUNT,
STATUS,
PAYMENT_DATE_LOCAL,
BATCH_CREATED_DATE,
DATE_TRUNC('MONTH', BATCH_CREATED_DATE) AS BATCH_CREATED_DATE_MONTH,
BATCH_CREATED_TIME,
DISBURSEMENT_METHOD,
DISBURSEMENT_TYPE,
TYPE,
CASE WHEN REPORT_DATE_LOCAL = BATCH_CREATED_DATE THEN 'SAME_DAY'
ELSE 'RESCHEDULED'
END AS PAYMENT_TYPE,
CASE WHEN PAYMENT_TYPE = 'RESCHEDULED' AND REPORT_DATE_LOCAL_MONTH = BATCH_CREATED_DATE_MONTH THEN 'SAME_MONTH'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND REPORT_DATE_LOCAL_MONTH != BATCH_CREATED_DATE_MONTH THEN 'DIFFERENT_MONTH'
ELSE 'NOT_RESCHEDULED'
END AS RESCHEDULED_TYPE,
CASE WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'DAILY' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN 'Reprogramaciones que se realizan en el mismo mes'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'DAILY' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN 'Reprogramaciones de meses anteriores'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'INSTANT' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN 'Reprogramaciones que se realizan en el mismo mes - Fast payments/Ledger'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'INSTANT' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN 'Reprogramaciones de meses anteriores - Fast payments/Ledger'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_TRAD' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN 'Reprogramaciones que se realizan en el mismo mes - Fast payments/Ledger'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_TRAD' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN 'Reprogramaciones de meses anteriores - Fast payments/Ledger'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_FP' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN 'Reprogramaciones que se realizan en el mismo mes - Fast payments/Ledger'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_FP' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN 'Reprogramaciones de meses anteriores - Fast payments/Ledger'
ELSE 'NOT_RESCHEDULED'
END AS SETTLEMENT_CONCEPT,
CASE WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'DAILY' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN '219-01-01'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'DAILY' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN '219-02-03'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'INSTANT' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN '219-01-01'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'INSTANT' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN '219-02-03'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_TRAD' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN '219-01-01'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_TRAD' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN '219-02-03'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_FP' AND RESCHEDULED_TYPE = 'SAME_MONTH' THEN '219-01-01'
WHEN PAYMENT_TYPE = 'RESCHEDULED' AND TYPE = 'LEDGER_FP' AND RESCHEDULED_TYPE = 'DIFFERENT_MONTH' THEN '219-02-03'
ELSE 'NOT_RESCHEDULED'
END AS ACCOUNTING

FROM(SELECT
    db.disbursement_batch_id,
    CASE
    WHEN r.type IS NULL THEN DATE(CONVERT_TIMEZONE('UTC','America/Mexico_City',d.report_date_local)) 
    ELSE DATE(d.report_date_local)
    END AS report_date_local,
    db.total_disbursements,
    d.amount,
    d.status,
    DATE(CONVERT_TIMEZONE('UTC','America/Mexico_City',d.updated_at))AS payment_date_local,
    DATE(CONVERT_TIMEZONE('UTC','America/Mexico_City',db.created_at))  AS batch_created_date,
    TIME(CONVERT_TIMEZONE('UTC','America/Mexico_City',db.created_at))  AS batch_created_time,
    db.disbursement_method,
    CASE WHEN batch_created_time BETWEEN '06:00:00' AND '09:27:00' THEN '01. First traditional'
    WHEN batch_created_time BETWEEN '09:27:01' AND '10:59:00' THEN '02. Second traditional'
    WHEN batch_created_time BETWEEN '10:59:01' AND '13:57:00' THEN '02. Second fast payment'
    WHEN batch_created_time BETWEEN '13:57:01' AND '14:02:00' THEN '03. Third traditional'
    WHEN batch_created_time BETWEEN '14:02:01' AND '15:59:00' THEN '03. Third fast payment'
    WHEN batch_created_time BETWEEN '15:59:01' AND '17:59:00' THEN '04. Fourh fast payment'
    WHEN batch_created_time BETWEEN '17:59:01' AND '19:59:00' THEN '05. Fifth fast payment'
    WHEN batch_created_time BETWEEN '19:59:01' AND '23:59:00' THEN '06. Sixth fast payment'
    ELSE 'not_defined'
    END AS DISBURSEMENT_TYPE,
    CASE WHEN r.type IS NULL AND CONTAINS(DISBURSEMENT_TYPE, 'traditional') THEN 'LEDGER_TRAD'
    WHEN r.type IS NULL AND CONTAINS(DISBURSEMENT_TYPE, 'fast payment')  THEN 'LEDGER_FP'
    ELSE r.type
    END AS TYPE
    FROM PRD_CLIP_ANALYTICS.CLIPDW_DISBURSEMENT.DISBURSEMENTS d
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDW_SETTLEMENT.REPORTS r ON r.report_id = d.report_id
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDW_DISBURSEMENT.DISBURSEMENT_BATCH_ENTRIES dbe ON dbe.disbursement_id = d.disbursement_id
    LEFT JOIN PRD_CLIP_ANALYTICS.CLIPDW_DISBURSEMENT.DISBURSEMENT_BATCHES db ON db.disbursement_batch_id = dbe.disbursement_batch_id)

    GROUP BY DISBURSEMENT_BATCH_ID, TOTAL_DISBURSEMENTS, REPORT_DATE_LOCAL, STATUS, BATCH_CREATED_DATE, PAYMENT_DATE_LOCAL, BATCH_CREATED_TIME, DISBURSEMENT_METHOD, DISBURSEMENT_TYPE, TYPE
    ORDER BY BATCH_CREATED_DATE, REPORT_DATE_LOCAL
    