SELECT c_final.COLLECTION_DATE_LOCAL AS COLLECTION_DATE_LOCAL,
c_final.LOAN_TYPE AS LOAN_TYPE,
CASE WHEN c_final.LOAN_TYPE = 'BETACREDIT SA DE CV SOFOM ENR' THEN 'CXC Loans Terceros Betacredit'
WHEN c_final.LOAN_TYPE = 'BISER PROCESOS SA DE CV SOFOM ENR' THEN 'CXC Loans Terceros Biser Procesos'
WHEN c_final.LOAN_TYPE = 'CENTEO SAPI DE CV' THEN 'CXC Loans Terceros Centeo'
WHEN c_final.LOAN_TYPE = 'R2 CAPITAL TECHNOLOGIES MX SA DE CV' THEN 'CXC Loans Terceros R2 Capital'
WHEN c_final.LOAN_TYPE = 'MR PRESTA SA DE CV SOFOM ENR' THEN 'CXC Loans Terceros Mr Presta'
WHEN c_final.LOAN_TYPE = 'PRESTACLIP' THEN 'Collections PrestaClip'
WHEN c_final.LOAN_TYPE = 'CAAL' THEN 'CXC Loans Terceros CAAL'
ELSE 'NOT_DEFINED'
END AS SETTLEMENT_CONCEPT,
CASE WHEN c_final.LOAN_TYPE = 'BETACREDIT SA DE CV SOFOM ENR' THEN '218-01-08'
WHEN c_final.LOAN_TYPE = 'BISER PROCESOS SA DE CV SOFOM ENR' THEN '218-01-07'
WHEN c_final.LOAN_TYPE = 'CENTEO SAPI DE CV' THEN '218-01-06'
WHEN c_final.LOAN_TYPE = 'R2 CAPITAL TECHNOLOGIES MX SA DE CV' THEN '218-01-04'
WHEN c_final.LOAN_TYPE = 'MR PRESTA SA DE CV SOFOM ENR' THEN '218-01-05'
WHEN c_final.LOAN_TYPE = 'PRESTACLIP' THEN '218-01-03'
WHEN c_final.LOAN_TYPE = 'CAAL' THEN '218-01-09'
ELSE 'NOT_DEFINED'
END AS ACCOUNTING,
ZEROIFNULL(c_final.AMOUNT) AS COLLECTION_AMOUNT,
ABS(ZEROIFNULL(ap_j_final.AMOUNT)) AS JOURNAL_AMOUNT,
ZEROIFNULL((COLLECTION_AMOUNT - JOURNAL_AMOUNT)) AS DIFF_AMOUNT

            FROM (SELECT c_prev.COLLECTION_DATE_LOCAL AS COLLECTION_DATE_LOCAL,
            CASE WHEN c_prev.PROVIDER_CODE = 'APH' AND l.FUNDED_BY IS NULL THEN 'BETACREDIT SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'APH' AND l.FUNDED_BY = 'APH' THEN 'BETACREDIT SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'AVL' AND l.FUNDED_BY IS NULL THEN 'BISER PROCESOS SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'AVL' AND l.FUNDED_BY = 'AVL' THEN 'BISER PROCESOS SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'CTO' AND l.FUNDED_BY IS NULL THEN 'CENTEO SAPI DE CV'
            WHEN c_prev.PROVIDER_CODE = 'CTO' AND l.FUNDED_BY = 'CTO' THEN 'CENTEO SAPI DE CV'
            WHEN c_prev.PROVIDER_CODE = 'R2' AND l.FUNDED_BY IS NULL THEN 'R2 CAPITAL TECHNOLOGIES MX SA DE CV'
            WHEN c_prev.PROVIDER_CODE = 'R2' AND l.FUNDED_BY = 'R2' THEN 'R2 CAPITAL TECHNOLOGIES MX SA DE CV'
            WHEN c_prev.PROVIDER_CODE = 'CLIP' AND l.FUNDED_BY IS NULL THEN 'PRESTACLIP'
            WHEN c_prev.PROVIDER_CODE = 'CLIP' AND l.FUNDED_BY = 'CLIP' THEN 'PRESTACLIP'
            WHEN c_prev.PROVIDER_CODE = 'MRP' AND l.FUNDED_BY IS NULL THEN 'MR PRESTA SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'MRP' AND l.FUNDED_BY = 'MRP' THEN 'MR PRESTA SA DE CV SOFOM ENR'
            WHEN c_prev.PROVIDER_CODE = 'MRP' AND l.FUNDED_BY = 'CLIP' THEN 'CAAL'
            ELSE 'NOT_DEFINED'
            END AS LOAN_TYPE,
            SUM(c_prev.amount) AS AMOUNT,
            CONCAT(COLLECTION_DATE_LOCAL, '_', LOAN_TYPE) AS INDEX_COLLECTION
            FROM "PRD_CLIP_ANALYTICS"."CLIPDW_LOANS"."COLLECTIONS" c_prev
            LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_LOANS"."LOANS" l ON c_prev.loan_id = l.loan_id
            WHERE c_prev.collection_origin = 'SETTLEMENT'
            GROUP BY COLLECTION_DATE_LOCAL, LOAN_TYPE, INDEX_COLLECTION) c_final
    
            LEFT JOIN (SELECT ap_j.EFF_DT,
            SUM(ap_j.AMOUNT) AS AMOUNT,
            LOAN_TYPE,
            CONCAT(EFF_DT, '_', LOAN_TYPE) AS INDEX_JOURNAL
            FROM (SELECT DATE(CONVERT_TIMEZONE('UTC','America/Mexico_City',record_data:eff_dt.S)) as eff_dt,
            (to_number(record_data:amount.N, 20, 4)) as AMOUNT,
            REPLACE(record_data:src_type.S, '""') as source_type,
            REPLACE(record_data:mvnt_id.S, '""') as mvnt_id
            FROM "PRD_CLIP_ANALYTICS"."CLIPDS_DYNAMO_SILVER"."AP_JOURNAL"
            WHERE source_type = 'LOAN') ap_j
        
            LEFT JOIN (SELECT c_prev_2.COLLECTION_ID AS COLLECTION_ID,
            c_prev_2.AMOUNT AS COLLECTIONS_AMOUNT,
            CASE WHEN c_prev_2.PROVIDER_CODE = 'APH' AND l_2.FUNDED_BY IS NULL THEN 'BETACREDIT SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'APH' AND l_2.FUNDED_BY = 'APH' THEN 'BETACREDIT SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'AVL' AND l_2.FUNDED_BY IS NULL THEN 'BISER PROCESOS SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'AVL' AND l_2.FUNDED_BY = 'AVL' THEN 'BISER PROCESOS SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'CTO' AND l_2.FUNDED_BY IS NULL THEN 'CENTEO SAPI DE CV'
            WHEN c_prev_2.PROVIDER_CODE = 'CTO' AND l_2.FUNDED_BY = 'CTO' THEN 'CENTEO SAPI DE CV'
            WHEN c_prev_2.PROVIDER_CODE = 'R2' AND l_2.FUNDED_BY IS NULL THEN 'R2 CAPITAL TECHNOLOGIES MX SA DE CV'
            WHEN c_prev_2.PROVIDER_CODE = 'R2' AND l_2.FUNDED_BY = 'R2' THEN 'R2 CAPITAL TECHNOLOGIES MX SA DE CV'
            WHEN c_prev_2.PROVIDER_CODE = 'CLIP' AND l_2.FUNDED_BY IS NULL THEN 'PRESTACLIP'
            WHEN c_prev_2.PROVIDER_CODE = 'CLIP' AND l_2.FUNDED_BY = 'CLIP' THEN 'PRESTACLIP'
            WHEN c_prev_2.PROVIDER_CODE = 'MRP' AND l_2.FUNDED_BY IS NULL THEN 'MR PRESTA SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'MRP' AND l_2.FUNDED_BY = 'MRP' THEN 'MR PRESTA SA DE CV SOFOM ENR'
            WHEN c_prev_2.PROVIDER_CODE = 'MRP' AND l_2.FUNDED_BY = 'CLIP' THEN 'CAAL'
            ELSE 'NOT_DEFINED'
            END AS LOAN_TYPE
            FROM "PRD_CLIP_ANALYTICS"."CLIPDW_LOANS"."COLLECTIONS" c_prev_2
            LEFT JOIN "PRD_CLIP_ANALYTICS"."CLIPDW_LOANS"."LOANS" l_2 ON c_prev_2.loan_id = l_2.loan_id
            WHERE c_prev_2.COLLECTION_ORIGIN ='SETTLEMENT') c ON c.COLLECTION_ID = ap_j.mvnt_id
            GROUP BY EFF_DT, LOAN_TYPE, INDEX_JOURNAL) ap_j_final ON ap_j_final.INDEX_JOURNAL = c_final.INDEX_COLLECTION

            WHERE COLLECTION_DATE_LOCAL >= '2024-01-01'
            AND COLLECTION_DATE_LOCAL <= '2024-01-31'
            ORDER BY COLLECTION_DATE_LOCAL, LOAN_TYPE